<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ViewPoint</title>
    <style>
        body {
            margin: 0;
            font-family: Arial, sans-serif;
            /* Added flex-direction: column here */
            display: flex;
            flex-direction: column;
            height: 100vh;
            background: linear-gradient(135deg, #fdfbfb, #f3e7e9, #e3eeff);
            background-size: cover;
        }

        /* spinner now displays halfway down the screen instead of just at top */
        #loading-spinner {
            display: none;
            position: fixed;
            top: 85%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            align-items: center;
            justify-content: center;
            gap: 10px;
            /* Space between spinner and text */
            font-size: 18px;
            font-weight: bold;
            color: #7d4f9e;
            /* Match the theme color */
        }

        .spinner-icon {
            width: 24px;
            height: 24px;
            border: 3px solid #ccc;
            border-top: 3px solid #7d4f9e;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .sidebar {
            width: 300px;
            background-color: #f3e7f9;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            border-right: 1px solid #ddd;
        }

        .sidebar-item {
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            color: #333;
            font-size: 16px;
        }

        .sidebar-item:hover {
            background-color: #e0d7f5;
        }

        .content {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 20px;
            background: linear-gradient(135deg, #fdfbfb, #f3e7e9, #e3eeff);
        }

        .content h1 {
            display: none;
        }

        #chat-container {
            margin: 20px auto;
            width: 100%;
            max-width: 1150px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            overflow-y: auto;
            /* scrolling if content overflows */
            display: flex;
            flex-direction: column;
            max-height: 60vh;
        }

        #tabs {
            display: flex;
            background: #9a6abf;
            padding: 10px;
            border-radius: 15px 15px 0 0;
            gap: 5px;
            justify-content: space-around;
        }

        .tab {
            flex: 1;
            padding: 12px;
            text-align: center;
            color: white;
            cursor: pointer;
            border-radius: 20px 20px 0 0;
            font-weight: bold;
            transition: background 0.3s;
        }

        .tab.active {
            background: #7d4f9e;
        }

        #chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            border-bottom: 1px solid #eee;
            background: #fafafa;
        }

        .perspective-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 20px;
        }

        .perspective-item {
            padding: 10px;
            border: 2px solid #9a6abf;
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
            font-weight: bold;
            background: white;
            transition: background 0.3s, border 0.3s;
        }

        .perspective-item.selected {
            background: #9a6abf;
            color: white;
            border-color: #7d4f9e;
        }

        .input-container {
            position: fixed;
            bottom: 20px;
            left: 50%;
            /* Move to the center of the page */
            transform: translateX(-50%);
            /* Shift it back by half its width */
            display: flex;
            align-items: center;
            background-color: #fff;
            border-radius: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 10px 20px;
            width: 75%;
            /* Adjust width as needed */
            max-width: 1200px;
            /* Prevent it from becoming too wide on large screens */
        }

        .input-container input {
            flex: 1;
            border: none;
            outline: none;
            font-size: 16px;
            padding: 10px;
        }

        .input-container button {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 20px;
            color: #6c63ff;
        }

        #confirm-selection {
            display: block;
            margin: 20px auto;
            /* center button */
            padding: 16px 32px;
            font-size: 18px;
            font-weight: bold;
            background: #e3d9ee;
            /* light purple bg */
            color: #7d4f9e;
            /* dark purple text */
            border: none;
            border-radius: 20px;
            /* round corners */
            cursor: pointer;
            transition: background 0.3s, transform 0.2s;
            width: 25%;
            text-align: center;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
        }

        /* New styles for messages */
        .user-message {
            text-align: right;
            margin: 10px 0;
            padding: 5px;
        }

        .ai-message {
            text-align: left;
            margin: 10px 0;
            padding: 5px;
        }


        /* Add these CSS styles to your stylesheet */

@keyframes pulse {
    0% { opacity: 0.6; }
    50% { opacity: 1; }
    100% { opacity: 0.6; }
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

@keyframes slideIn {
    from { opacity: 0; transform: translateX(-20px); }
    to { opacity: 1; transform: translateX(0); }
}

#debate-layout {
    animation: fadeIn 0.5s ease-out;
}

#debate-container {
    animation: slideIn 0.5s ease-out;
    transition: all 0.3s ease;
}

#debate-container:hover {
    box-shadow: 0 6px 15px rgba(0, 0, 0, 0.1);
}

.debate-user-message, 
.debate-response {
    animation: fadeIn 0.4s ease-out;
}

.debate-continue-btn, 
.debate-newtopic-btn {
    transition: all 0.3s ease;
}

.debate-continue-btn:hover {
    opacity: 0.9;
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
}

.debate-newtopic-btn:hover {
    background: #d1c3e6 !important;
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
}

.debate-perspective-btn {
    transition: all 0.3s ease;
}

.debate-perspective-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
}

.debate-buttons {
    animation: fadeIn 0.4s ease-out;
}

#debate-messages {
    scrollbar-width: thin;
    scrollbar-color: #9a6abf #f1e6fb;
}

#debate-messages::-webkit-scrollbar {
    width: 8px;
}

#debate-messages::-webkit-scrollbar-track {
    background: #f1e6fb;
}

#debate-messages::-webkit-scrollbar-thumb {
    background-color: #9a6abf;
    border-radius: 20px;
}

#debate-input {
    outline: none;
    transition: all 0.3s ease;
}

#debate-input:focus {
    border-color: #9a6abf;
    box-shadow: 0 0 0 2px rgba(154, 106, 191, 0.2);
}

#start-debate-btn {
    transition: all 0.3s ease;
}

#start-debate-btn:hover {
    background: #d1c3e6;
    transform: translateY(-2px);
    box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
}

/* Responsive styles for mobile */
@media (max-width: 768px) {
    #debate-layout {
        flex-direction: column;
    }
    
    #chat-container, #debate-container {
        width: 100%;
        margin-bottom: 20px;
    }
    
    .debate-buttons {
        flex-direction: column;
        gap: 10px;
    }
    
    .debate-continue-btn, .debate-newtopic-btn {
        width: 100%;
    }
}
    </style>
</head>

<body>
    <!-- New header block -->
    <div id="header" style="text-align: center; margin-top: 40px; margin-bottom: 0px;">
        <div style="font-size: 36px; font-weight: bold;">Viewpoint</div>
        <div id="subheading" style="font-size: 18px; padding-top: 20px;">
            Step 1: Describe your situation
        </div>
    </div>

    <div class="content">
        <h1>Step 2: Select 3 Perspectives</h1>
        <div id="loading-spinner">
            <span class="spinner-icon"></span> Loading perspectives...
        </div>
        <div class="perspective-list" id="perspective-list"></div>
        <button id="confirm-selection">Confirm Selection</button>

        <div id="chat-container" style="display: none;">
            <div id="tabs"></div>
            <div id="chat-messages"></div>
        </div>
    </div>

    <div class="input-container">
        <input type="text" id="user-input" placeholder="Ask me anything about your situation" />
        <button id="send-button">âž¤</button>
    </div>

    <script>
        let selectedPerspectives = [];
        let perspectives = {};
        let initialUserInput = "";
        // Add this to your script section

// Global variables for debate feature
let debatePerspectives = [];
let debateActive = false;
let debateSessionId = null;

// Function to initiate debate selection
function initiateDebateFeature() {
  // Check if button already exists
  if (document.getElementById("start-debate-btn")) {
    return;
  }
  
  // Create debate button
  const debateButton = document.createElement("button");
  debateButton.id = "start-debate-btn";
  debateButton.textContent = "Start Perspective Debate";
  debateButton.className = "feature-button";
  debateButton.style.display = "block";
  debateButton.style.margin = "20px auto";
  debateButton.style.padding = "16px 32px";
  debateButton.style.fontSize = "18px";
  debateButton.style.fontWeight = "bold";
  debateButton.style.background = "#e3d9ee";
  debateButton.style.color = "#7d4f9e";
  debateButton.style.border = "none";
  debateButton.style.borderRadius = "20px";
  debateButton.style.cursor = "pointer";
  debateButton.style.width = "25%";
  debateButton.style.textAlign = "center";
  debateButton.style.boxShadow = "0 4px 10px rgba(0, 0, 0, 0.05)";
  
  // Add click event
  debateButton.addEventListener("click", showDebateSelection);
  
  // Add button to the page
  const contentArea = document.querySelector(".content");
  contentArea.appendChild(debateButton);
}

// Show perspective selection for debate
function showDebateSelection() {
  // Hide the debate button
  document.getElementById("start-debate-btn").style.display = "none";
  
  // Create selection container
  const selectionContainer = document.createElement("div");
  selectionContainer.id = "debate-selection";
  selectionContainer.style.width = "100%";
  selectionContainer.style.maxWidth = "600px";
  selectionContainer.style.margin = "20px auto";
  selectionContainer.style.padding = "20px";
  selectionContainer.style.background = "white";
  selectionContainer.style.borderRadius = "10px";
  selectionContainer.style.boxShadow = "0 4px 10px rgba(0, 0, 0, 0.1)";
  selectionContainer.style.textAlign = "center";
  
  // Add heading
  const heading = document.createElement("h3");
  heading.textContent = "Select two perspectives for debate";
  heading.style.marginBottom = "20px";
  heading.style.color = "#7d4f9e";
  selectionContainer.appendChild(heading);
  
  // Create perspective selection container
  const perspectiveButtonContainer = document.createElement("div");
  perspectiveButtonContainer.style.display = "flex";
  perspectiveButtonContainer.style.flexWrap = "wrap";
  perspectiveButtonContainer.style.gap = "10px";
  perspectiveButtonContainer.style.justifyContent = "center";
  perspectiveButtonContainer.style.marginBottom = "20px";
  
  // Add buttons for each perspective
  selectedPerspectives.forEach(key => {
    const button = document.createElement("button");
    button.className = "debate-perspective-btn";
    button.textContent = perspectives[key];
    button.setAttribute("data-key", key);
    button.style.padding = "10px 15px";
    button.style.border = "2px solid #9a6abf";
    button.style.borderRadius = "8px";
    button.style.background = "white";
    button.style.color = "#333";
    button.style.fontWeight = "bold";
    button.style.cursor = "pointer";
    
    button.addEventListener("click", function() {
      const key = this.getAttribute("data-key");
      
      // Toggle selection
      if (debatePerspectives.includes(key)) {
        debatePerspectives = debatePerspectives.filter(p => p !== key);
        this.style.background = "white";
        this.style.color = "#333";
      } else if (debatePerspectives.length < 2) {
        debatePerspectives.push(key);
        this.style.background = "#9a6abf";
        this.style.color = "white";
      }
      
      // Enable/disable confirm button
      if (debatePerspectives.length === 2) {
        document.getElementById("confirm-debate-btn").disabled = false;
        document.getElementById("confirm-debate-btn").style.opacity = "1";
      } else {
        document.getElementById("confirm-debate-btn").disabled = true;
        document.getElementById("confirm-debate-btn").style.opacity = "0.5";
      }
    });
    
    perspectiveButtonContainer.appendChild(button);
  });
  
  selectionContainer.appendChild(perspectiveButtonContainer);
  
  // Add confirm button
  const confirmButton = document.createElement("button");
  confirmButton.id = "confirm-debate-btn";
  confirmButton.textContent = "Start Debate";
  confirmButton.style.padding = "12px 24px";
  confirmButton.style.background = "#9a6abf";
  confirmButton.style.color = "white";
  confirmButton.style.border = "none";
  confirmButton.style.borderRadius = "20px";
  confirmButton.style.fontWeight = "bold";
  confirmButton.style.cursor = "pointer";
  confirmButton.style.opacity = "0.5";
  confirmButton.disabled = true;
  
  confirmButton.addEventListener("click", setupDebateInterface);
  
  selectionContainer.appendChild(confirmButton);
  
  // Add to page
  document.querySelector(".content").appendChild(selectionContainer);
}

// Set up the debate interface
function setupDebateInterface() {
  debateActive = true;
  
  // Hide selection container
  document.getElementById("debate-selection").style.display = "none";
  
  // Update subheading
  document.getElementById("subheading").textContent = "Perspective Debate";
  
  // Create container for main + debate layout
  const layoutContainer = document.createElement("div");
  layoutContainer.id = "debate-layout";
  layoutContainer.style.display = "flex";
  layoutContainer.style.gap = "20px";
  layoutContainer.style.width = "100%";
  layoutContainer.style.maxWidth = "1200px";
  layoutContainer.style.margin = "0 auto";
  
  // Add main chat to layout container
  const chatContainer = document.getElementById("chat-container");
  chatContainer.style.flex = "1";
  chatContainer.style.maxWidth = "none";
  
  // Create debate container
  const debateContainer = document.createElement("div");
  debateContainer.id = "debate-container";
  debateContainer.style.flex = "1";
  debateContainer.style.display = "flex";
  debateContainer.style.flexDirection = "column";
  debateContainer.style.background = "white";
  debateContainer.style.borderRadius = "10px";
  debateContainer.style.boxShadow = "0 4px 10px rgba(0, 0, 0, 0.1)";
  debateContainer.style.overflow = "hidden";
  
  // Create debate header
  const debateHeader = document.createElement("div");
  debateHeader.className = "debate-header";
  debateHeader.style.padding = "15px";
  debateHeader.style.background = "#9a6abf";
  debateHeader.style.color = "white";
  debateHeader.style.textAlign = "center";
  debateHeader.style.fontWeight = "bold";
  debateHeader.style.borderRadius = "10px 10px 0 0";
  debateHeader.innerHTML = `Debate: ${perspectives[debatePerspectives[0]]} & ${perspectives[debatePerspectives[1]]}`;
  
  // Create debate messages area
  const debateMessages = document.createElement("div");
  debateMessages.id = "debate-messages";
  debateMessages.style.flex = "1";
  debateMessages.style.padding = "15px";
  debateMessages.style.overflowY = "auto";
  debateMessages.style.background = "#f9f9f9";
  debateMessages.style.height = "350px";
  
  // Add initial instruction
  const instructionDiv = document.createElement("div");
  instructionDiv.className = "debate-instruction";
  instructionDiv.style.padding = "15px";
  instructionDiv.style.margin = "10px 0";
  instructionDiv.style.background = "#f0f0f0";
  instructionDiv.style.borderRadius = "8px";
  instructionDiv.style.textAlign = "center";
  instructionDiv.innerHTML = "Enter a topic or question below for these perspectives to debate";
  debateMessages.appendChild(instructionDiv);
  
  // Create debate input area
  const debateInputContainer = document.createElement("div");
  debateInputContainer.className = "debate-input-container";
  debateInputContainer.style.display = "flex";
  debateInputContainer.style.padding = "15px";
  debateInputContainer.style.background = "white";
  debateInputContainer.style.borderTop = "1px solid #eee";
  
  // Create input
  const debateInput = document.createElement("input");
  debateInput.type = "text";
  debateInput.id = "debate-input";
  debateInput.placeholder = "Enter debate topic...";
  debateInput.style.flex = "1";
  debateInput.style.padding = "10px 15px";
  debateInput.style.border = "1px solid #ddd";
  debateInput.style.borderRadius = "20px";
  debateInput.style.fontSize = "14px";
  debateInput.style.marginRight = "10px";
  
  debateInput.addEventListener("keypress", function(e) {
    if (e.key === "Enter") {
      startDebate();
    }
  });
  
  // Create send button
  const debateSendButton = document.createElement("button");
  debateSendButton.id = "debate-send-btn";
  debateSendButton.innerHTML = "Start";
  debateSendButton.style.padding = "10px 20px";
  debateSendButton.style.background = "#9a6abf";
  debateSendButton.style.color = "white";
  debateSendButton.style.border = "none";
  debateSendButton.style.borderRadius = "20px";
  debateSendButton.style.fontWeight = "bold";
  debateSendButton.style.cursor = "pointer";
  
  debateSendButton.addEventListener("click", startDebate);
  
  // Assemble input container
  debateInputContainer.appendChild(debateInput);
  debateInputContainer.appendChild(debateSendButton);
  
  // Assemble debate container
  debateContainer.appendChild(debateHeader);
  debateContainer.appendChild(debateMessages);
  debateContainer.appendChild(debateInputContainer);
  
  // Create the overall container for both original and debate
  const contentArea = document.querySelector(".content");
  contentArea.innerHTML = '';
  
  // Add both to layout container
  layoutContainer.appendChild(chatContainer);
  layoutContainer.appendChild(debateContainer);
  
  // Add layout to page
  contentArea.appendChild(layoutContainer);
  
  // Make sure the original chat container is visible
  chatContainer.style.display = "block";
  
  // Focus on debate input
  debateInput.focus();
}

// Start the debate with user's topic
function startDebate() {
  const topic = document.getElementById("debate-input").value.trim();
  if (!topic) return;
  
  // Reset session ID when starting a new debate
  debateSessionId = null;
  
  // Clear input
  document.getElementById("debate-input").value = "";
  
  // Disable input while debate is in progress
  document.getElementById("debate-input").disabled = true;
  document.getElementById("debate-send-btn").disabled = true;
  
  // Display user message
  const userDiv = document.createElement("div");
  userDiv.className = "debate-user-message";
  userDiv.style.textAlign = "right";
  userDiv.style.margin = "10px 0";
  userDiv.innerHTML = 
    `<div style="display: inline-block; background: #e3eeff; padding: 10px; border-radius: 10px; max-width: 80%;">
      <strong>You:</strong> ${topic}
    </div>`;
  document.getElementById("debate-messages").appendChild(userDiv);
  
  // Show loading indicator
  const loadingDiv = document.createElement("div");
  loadingDiv.id = "debate-loading";
  loadingDiv.style.textAlign = "center";
  loadingDiv.style.margin = "15px 0";
  loadingDiv.innerHTML = 
    `<div style="display: inline-block; padding: 10px; border-radius: 10px; background: #f0f0f0;">
      <span style="display: inline-block; width: 12px; height: 12px; border-radius: 50%; background: #9a6abf; margin-right: 10px; animation: pulse 1s infinite;"></span>
      Generating responses...
    </div>`;
  document.getElementById("debate-messages").appendChild(loadingDiv);
  
  // Scroll to bottom
  document.getElementById("debate-messages").scrollTop = document.getElementById("debate-messages").scrollHeight;
  
  // Get first perspective response (perspective 1)
  getDebateResponse(debatePerspectives[0], topic, false).then(response => {
    // Save the session ID from the response
    debateSessionId = response.session_id;
    
    // Remove loading indicator
    document.getElementById("debate-loading").remove();
    
    // Display first perspective's response
    displayDebateResponse(debatePerspectives[0], response.response);
    
    // Now get second perspective's response
    const loadingDiv2 = document.createElement("div");
    loadingDiv2.id = "debate-loading";
    loadingDiv2.style.textAlign = "center";
    loadingDiv2.style.margin = "15px 0";
    loadingDiv2.innerHTML = 
      `<div style="display: inline-block; padding: 10px; border-radius: 10px; background: #f0f0f0;">
        <span style="display: inline-block; width: 12px; height: 12px; border-radius: 50%; background: #9a6abf; margin-right: 10px; animation: pulse 1s infinite;"></span>
        ${perspectives[debatePerspectives[1]]} is responding...
      </div>`;
    document.getElementById("debate-messages").appendChild(loadingDiv2);
    
    // Scroll to bottom
    document.getElementById("debate-messages").scrollTop = document.getElementById("debate-messages").scrollHeight;
    
    // Get second perspective response (perspective 2)
    return getDebateResponse(debatePerspectives[1], topic, true, debatePerspectives[0], response.response);
  }).then(response => {
    // Remove loading indicator
    document.getElementById("debate-loading").remove();
    
    // Display second perspective's response
    displayDebateResponse(debatePerspectives[1], response.response);
    
    // Show response buttons for continuing the debate
    showDebateButtons();
  }).catch(error => {
    console.error("Error starting debate:", error);
    
    // Remove loading indicator if present
    if (document.getElementById("debate-loading")) {
      document.getElementById("debate-loading").remove();
    }
    
    // Show error message
    const errorDiv = document.createElement("div");
    errorDiv.style.textAlign = "center";
    errorDiv.style.margin = "15px 0";
    errorDiv.style.color = "red";
    errorDiv.textContent = "Error generating debate responses. Please try again.";
    document.getElementById("debate-messages").appendChild(errorDiv);
    
    // Re-enable input
    document.getElementById("debate-input").disabled = false;
    document.getElementById("debate-send-btn").disabled = false;
  });
}


// Display a response in the debate
function displayDebateResponse(perspectiveKey, response) {
  const responseDiv = document.createElement("div");
  responseDiv.className = "debate-response";
  responseDiv.setAttribute("data-perspective", perspectiveKey);
  responseDiv.style.margin = "15px 0";
  
  // Different styling for each perspective
  let bgColor = perspectiveKey === debatePerspectives[0] ? "#f1e6fb" : "#e6f0fa";
  
  responseDiv.innerHTML = 
    `<div style="display: inline-block; background: ${bgColor}; padding: 12px; border-radius: 10px; max-width: 80%;">
      <strong>${perspectives[perspectiveKey]}:</strong> ${response}
    </div>`;
  
  document.getElementById("debate-messages").appendChild(responseDiv);
  
  // Scroll to bottom
  document.getElementById("debate-messages").scrollTop = document.getElementById("debate-messages").scrollHeight;
}

// Show buttons to continue the debate
function showDebateButtons() {
  // Create button container
  const buttonContainer = document.createElement("div");
  buttonContainer.className = "debate-buttons";
  buttonContainer.id = "debate-buttons";
  buttonContainer.style.display = "flex";
  buttonContainer.style.justifyContent = "center";
  buttonContainer.style.gap = "10px";
  buttonContainer.style.margin = "15px 0";
  
  // Create button for perspective 1
  const button1 = document.createElement("button");
  button1.className = "debate-continue-btn";
  button1.textContent = `Let ${perspectives[debatePerspectives[0]]} respond`;
  button1.setAttribute("data-perspective", debatePerspectives[0]);
  button1.style.padding = "10px 15px";
  button1.style.background = "#f1e6fb";
  button1.style.color = "#333";
  button1.style.border = "none";
  button1.style.borderRadius = "20px";
  button1.style.fontWeight = "bold";
  button1.style.cursor = "pointer";
  
  button1.addEventListener("click", function() {
    continueDebate(debatePerspectives[0]);
  });
  
  // Create button for perspective 2
  const button2 = document.createElement("button");
  button2.className = "debate-continue-btn";
  button2.textContent = `Let ${perspectives[debatePerspectives[1]]} respond`;
  button2.setAttribute("data-perspective", debatePerspectives[1]);
  button2.style.padding = "10px 15px";
  button2.style.background = "#e6f0fa";
  button2.style.color = "#333";
  button2.style.border = "none";
  button2.style.borderRadius = "20px";
  button2.style.fontWeight = "bold";
  button2.style.cursor = "pointer";
  
  button2.addEventListener("click", function() {
    continueDebate(debatePerspectives[1]);
  });
  
  // Create new topic button
  const newTopicButton = document.createElement("button");
  newTopicButton.className = "debate-newtopic-btn";
  newTopicButton.textContent = "New Topic";
  newTopicButton.style.padding = "10px 15px";
  newTopicButton.style.background = "#e3d9ee";
  newTopicButton.style.color = "#7d4f9e";
  newTopicButton.style.border = "none";
  newTopicButton.style.borderRadius = "20px";
  newTopicButton.style.fontWeight = "bold";
  newTopicButton.style.cursor = "pointer";
  
  newTopicButton.addEventListener("click", function() {
    // Remove buttons
    document.getElementById("debate-buttons").remove();
    
    // Enable input
    document.getElementById("debate-input").disabled = false;
    document.getElementById("debate-send-btn").disabled = false;
    document.getElementById("debate-input").focus();
    
    // Change send button text back to "Start"
    document.getElementById("debate-send-btn").textContent = "Start";
  });
  
  // Add buttons to container
  buttonContainer.appendChild(button1);
  buttonContainer.appendChild(button2);
  buttonContainer.appendChild(newTopicButton);
  
  // Add to debate messages
  document.getElementById("debate-messages").appendChild(buttonContainer);
  
  // Scroll to bottom
  document.getElementById("debate-messages").scrollTop = document.getElementById("debate-messages").scrollHeight;
}

// Continue the debate with selected perspective
function continueDebate(perspectiveKey) {
  // Remove buttons
  document.getElementById("debate-buttons").remove();
  
  // Get the latest response from the other perspective
  const otherPerspectiveKey = debatePerspectives.find(key => key !== perspectiveKey);
  const allResponses = document.querySelectorAll('.debate-response');
  let latestOtherResponse = null;
  
  // Loop from the end to find the most recent response from the other perspective
  for (let i = allResponses.length - 1; i >= 0; i--) {
    if (allResponses[i].getAttribute('data-perspective') === otherPerspectiveKey) {
      latestOtherResponse = allResponses[i].textContent.trim();
      break;
    }
  }
  
  // Show loading indicator
  const loadingDiv = document.createElement("div");
  loadingDiv.id = "debate-loading";
  loadingDiv.style.textAlign = "center";
  loadingDiv.style.margin = "15px 0";
  loadingDiv.innerHTML = 
    `<div style="display: inline-block; padding: 10px; border-radius: 10px; background: #f0f0f0;">
      <span style="display: inline-block; width: 12px; height: 12px; border-radius: 50%; background: #9a6abf; margin-right: 10px; animation: pulse 1s infinite;"></span>
      ${perspectives[perspectiveKey]} is responding...
    </div>`;
  document.getElementById("debate-messages").appendChild(loadingDiv);
  
  // Scroll to bottom
  document.getElementById("debate-messages").scrollTop = document.getElementById("debate-messages").scrollHeight;
  
  // Get counterpoint response
  getDebateCounterpoint(perspectiveKey, otherPerspectiveKey, latestOtherResponse)
    .then(response => {
      // Remove loading indicator
      document.getElementById("debate-loading").remove();
      
      // Display response
      displayDebateResponse(perspectiveKey, response.response);
      
      // Show buttons again
      showDebateButtons();
    })
    .catch(error => {
      console.error("Error continuing debate:", error);
      
      // Remove loading indicator
      document.getElementById("debate-loading").remove();
      
      // Show error message
      const errorDiv = document.createElement("div");
      errorDiv.style.textAlign = "center";
      errorDiv.style.margin = "15px 0";
      errorDiv.style.color = "red";
      errorDiv.textContent = "Error generating response. Please try again.";
      document.getElementById("debate-messages").appendChild(errorDiv);
      
      // Show buttons again
      showDebateButtons();
    });
}

// Get API response for debate start
function getDebateResponse(perspectiveKey, topic, isSecondPerspective, firstPerspectiveKey, firstResponse) {
  // API parameters
  const params = {
    perspective_key: perspectiveKey,
    perspective: perspectives[perspectiveKey],
    topic: topic
  };
  
  // If we have a session ID, include it
  if (debateSessionId) {
    params.session_id = debateSessionId;
  }
  
  // If it's the second perspective, add context from first response
  if (isSecondPerspective && firstPerspectiveKey && firstResponse) {
    params.other_perspective_key = firstPerspectiveKey;
    params.other_perspective = perspectives[firstPerspectiveKey];
    params.other_response = firstResponse;
  }
  
  // Make API request
  return fetch("/get_debate_response", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(params)
  })
  .then(response => {
    if (!response.ok) {
      throw new Error("API response was not ok");
    }
    return response.json();
  })
  .then(data => {
    if (data.response) {
      // If there's a session ID in the response, store it
      if (data.session_id) {
        debateSessionId = data.session_id;
      }
      return data;
    } else {
      throw new Error("No response in API data");
    }
  });
}


// Get API response for debate continuation
// Get API response for debate continuation
function getDebateCounterpoint(perspectiveKey, otherPerspectiveKey, otherResponse) {
  return fetch("/get_debate_counterpoint", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      perspective_key: perspectiveKey,
      perspective: perspectives[perspectiveKey],
      other_perspective_key: otherPerspectiveKey,
      other_perspective: perspectives[otherPerspectiveKey],
      other_response: otherResponse,
      session_id: debateSessionId
    })
  })
  .then(response => {
    if (!response.ok) {
      throw new Error("API response was not ok");
    }
    return response.json();
  })
  .then(data => {
    if (data.response) {
      return data;
    } else {
      throw new Error("No response in API data");
    }
  });
}

// Modify confirmPerspectivesAndInitializeChat to add debate button
function confirmPerspectivesAndInitializeChat() {
  if (selectedPerspectives.length === 3) {
    var spinner = document.getElementById("loading-spinner");
    
    spinner.innerHTML = '<span class="spinner-icon"></span> Loading responses...';
    spinner.style.display = "flex";
    
    fetch("/get_response", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        user_input: initialUserInput,
        selected_perspectives: selectedPerspectives
      })
    })
    .then(response => response.json())
    .then(data => {
      spinner.style.display = "none";
      console.log("Perspective Confirmation Response:", data);
      
      document.getElementById("chat-container").style.display = "block";
      document.getElementById("subheading").textContent =
        "Step 3: Follow-up with specific perspectives";
      
      createChatTabs();
      updateChatInterface(data);
      
      document.querySelector("h1").style.display = "none";
      document.getElementById("perspective-list").style.display = "none";
      document.getElementById("confirm-selection").style.display = "none";
      
      document.getElementById("user-input").placeholder =
        "Enter follow-up message for a specific perspective";
      document.getElementById("user-input").value = "";
      
      // Add debate feature button
      initiateDebateFeature();
    })
    .catch(error => {
      spinner.style.display = "none";
      console.error("Error confirming perspectives:", error);
    });
  } else {
    alert("Please select exactly 3 perspectives.");
  }
}

        // Fetch perspectives from the backend
        function fetchPerspectives(userInput) {
            initialUserInput = userInput; // Store the initial user input for later use

            fetch("/get_response", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ user_input: userInput })
            })
                .then((response) => response.json())
                .then((data) => {
                    console.log("Backend Response:", data); // Log the response
                    if (data.perspectives) {
                        perspectives = data.perspectives; // Store the fetched perspectives
                        displayPerspectives(); // Render the perspectives as buttons
                    } else {
                        console.error("No perspectives found in response:", data);
                    }
                })
                .catch((error) =>
                    console.error("Error fetching perspectives:", error)
                );
        }

        // Render perspectives as clickable buttons
        function displayPerspectives() {
            const list = document.getElementById("perspective-list");
            list.innerHTML = ""; // Clear the list before rendering

            console.log("Perspectives to Render:", perspectives); // Log the perspectives

            Object.entries(perspectives).forEach(([key, text]) => {
                const button = document.createElement("button");
                button.className = "perspective-item";
                button.textContent = text;
                button.setAttribute("data-key", key);

                button.addEventListener("click", () => {
                    if (selectedPerspectives.includes(key)) {
                        selectedPerspectives = selectedPerspectives.filter(
                            (k) => k !== key
                        );
                        button.classList.remove("selected");
                    } else if (selectedPerspectives.length < 3) {
                        selectedPerspectives.push(key);
                        button.classList.add("selected");
                    }
                    console.log("Selected Perspectives:", selectedPerspectives);
                });

                list.appendChild(button);
            });
        }

        // Confirm selection and initialize chat
        document
            .getElementById("confirm-selection")
            .addEventListener("click", () => {
                if (selectedPerspectives.length === 3) {
                    confirmPerspectivesAndInitializeChat();
                } else {
                    alert("Please select exactly 3 perspectives.");
                }
            });
            
            /*
        // Send selected perspectives to backend and initialize chat
        function confirmPerspectivesAndInitializeChat() {
            var spinner = document.getElementById("loading-spinner");

            spinner.innerHTML =
                '<span class="spinner-icon"></span> Loading responses...';
            spinner.style.display = "flex";

            fetch("/get_response", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    user_input: initialUserInput,
                    selected_perspectives: selectedPerspectives
                })
            })
                .then((response) => response.json())
                .then((data) => {
                    spinner.style.display = "none";
                    console.log("Perspective Confirmation Response:", data);

                    document.getElementById("chat-container").style.display = "block";
                    document.getElementById("subheading").textContent =
                        "Step 3: Follow-up with specific perspectives";

                    createChatTabs();
                    updateChatInterface(data);

                    document.querySelector("h1").style.display = "none";
                    document.getElementById("perspective-list").style.display = "none";
                    document.getElementById("confirm-selection").style.display = "none";

                    document.getElementById("user-input").placeholder =
                        "Enter follow-up message for a specific perspective";
                    document.getElementById("user-input").value = "";
                })
                .catch((error) => {
                    spinner.style.display = "none";
                    console.error("Error confirming perspectives:", error);
                });
        }
        */

        // Create tabs for the chat interface (only one tab per selected perspective)
        function createChatTabs() {
            const tabsContainer = document.getElementById("tabs");
            tabsContainer.innerHTML = "";

            selectedPerspectives.forEach((key, index) => {
                const tab = document.createElement("div");
                tab.className = "tab";
                if (index === 0) {
                    tab.classList.add("active");
                }
                tab.textContent = perspectives[key];
                tab.setAttribute("data-tab", key);
                tabsContainer.appendChild(tab);
            });

            document.querySelectorAll(".tab").forEach((tab) => {
                tab.addEventListener("click", function () {
                    document
                        .querySelectorAll(".tab")
                        .forEach((t) => t.classList.remove("active"));
                    this.classList.add("active");
                    displayMessagesForTab(this.getAttribute("data-tab"));
                });
            });
        }

        // Fetch messages for a specific perspective
        function fetchPerspectives(userInput) {
            initialUserInput = userInput;
            const spinner = document.getElementById("loading-spinner");
            spinner.style.display = "flex";

            fetch("/get_response", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ user_input: userInput })
            })
                .then((response) => response.json())
                .then((data) => {
                    spinner.style.display = "none";
                    console.log("Backend Response:", data);
                    if (data.perspectives) {
                        perspectives = data.perspectives;
                        displayPerspectives();
                    } else {
                        console.error("No perspectives found in response:", data);
                    }
                })
                .catch((error) => {
                    spinner.style.display = "none";
                    console.error("Error fetching perspectives:", error);
                });
        }

        // Send user input to the backend
        document
            .getElementById("send-button")
            .addEventListener("click", () => {
                const message = document.getElementById("user-input").value.trim();
                if (!message) return;

                if (Object.keys(perspectives).length === 0) {
                    document.getElementById("subheading").textContent =
                        "Step 2: Select 3 perspectives";
                    fetchPerspectives(message);
                } else {
                    sendMessage();
                }
            });

        // Allow sending messages with Enter key
        document
            .getElementById("user-input")
            .addEventListener("keypress", (e) => {
                if (e.key === "Enter") {
                    document.getElementById("send-button").click();
                }
            });

        // Display messages for the selected tab
        function displayMessagesForTab(tab) {
            const chatMessages = document.getElementById("chat-messages");
            chatMessages.innerHTML = "";

            if (
                conversationHistory &&
                conversationHistory.conversations &&
                conversationHistory.conversations[tab]
            ) {
                conversationHistory.conversations[tab].forEach((message) => {
                    // Create container for the user message (right-aligned)
                    const userDiv = document.createElement("div");
                    userDiv.className = "user-message";
                    userDiv.innerHTML =
                        '<p style="text-align: right;"><strong>You:</strong> ' +
                        message.user +
                        "</p>";
                    chatMessages.appendChild(userDiv);

                    // Create container for the AI response (left-aligned)
                    if (message.ai) {
                        const aiDiv = document.createElement("div");
                        aiDiv.className = "ai-message";
                        aiDiv.innerHTML =
                            '<p style="text-align: left;"><strong>' +
                            perspectives[tab] +
                            ":</strong> " +
                            message.ai +
                            "</p>";
                        chatMessages.appendChild(aiDiv);
                    }
                });
            }
        }

        // Global variable to store conversation history
        let conversationHistory = {};

        // Update chat interface and store conversation history
        function updateChatInterface(data) {
            conversationHistory = data;
            const chatMessages = document.getElementById("chat-messages");
            chatMessages.innerHTML = "";
            const activeTab = document.querySelector(".tab.active");
            const currentTab = activeTab
                ? activeTab.getAttribute("data-tab")
                : "all";
            displayMessagesForTab(currentTab);
        }

        // Send follow-up message
        function sendMessage() {
            const userInput = document.getElementById("user-input").value.trim();
            if (!userInput) return;

            const activeTab = document.querySelector(".tab.active");
            const currentTab = activeTab
                ? activeTab.getAttribute("data-tab")
                : "all";

            const spinner = document.getElementById("loading-spinner");
            spinner.innerHTML =
                '<span class="spinner-icon"></span> Loading follow-up response...';
            spinner.style.display = "flex";

            fetch("/get_response", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    user_input: userInput,
                    tab: currentTab,
                    selected_perspectives: selectedPerspectives
                })
            })
                .then((response) => response.json())
                .then((data) => {
                    spinner.style.display = "none";
                    console.log("New Message Response:", data);
                    updateChatInterface(data);
                    document.getElementById("user-input").value = "";
                })
                .catch((error) => {
                    spinner.style.display = "none";
                    console.error("Error sending message:", error);
                });
        }
    </script>
</body>

</html>